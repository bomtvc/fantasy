{% extends "base.html" %}

{% block content %}
<div class="league-members-page">
    <!-- Members will be displayed as cards -->
    <div id="members-container" class="members-grid"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // League Members Page Logic
    document.addEventListener('DOMContentLoaded', function () {
        // Load data if league ID is set
        const leagueId = document.getElementById('league-id').value;
        if (leagueId) {
            loadLeagueMembers();
        }
    });

    // Override reloadPageData (force refresh when filters change)
    window.reloadPageData = function (filters) {
        DataCache.clear('league_members');
        DataCache.clear('league_info');
        loadLeagueMembers(true);
    };

    let currentGW = 1; // Will be updated from API

    async function loadLeagueMembers(forceRefresh = false) {
        const filters = getCurrentFilters();

        // Validate
        const validation = validateFilters(filters);
        if (!validation.valid) {
            validation.errors.forEach(error => showToast(error, 'error'));
            return;
        }

        try {
            showLoading('Loading league members...');

            // First get current GW with cache
            const leagueData = await cachedFetch('league_info', `/api/league/${filters.league_id}?phase=${filters.phase}`, forceRefresh);
            if (leagueData.success && leagueData.data.current_gw) {
                currentGW = leagueData.data.current_gw;
            }

            const data = await cachedFetch('league_members', `/api/league/${filters.league_id}/entries?phase=${filters.phase}`, forceRefresh);

            if (data.success) {
                renderMembers(data.data);
                showToast('League members loaded successfully', 'success');
            } else {
                showToast(data.error || 'Failed to load data', 'error');
            }
        } catch (error) {
            console.error('Error loading league members:', error);
            showToast('Error loading data', 'error');
        } finally {
            hideLoading();
        }
    }

    function renderMembers(members) {
        const container = document.getElementById('members-container');

        if (!members || members.length === 0) {
            container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üë•</div>
                <h3 class="empty-title">No Members Found</h3>
                <p class="empty-text">Check your league ID and try again.</p>
            </div>
        `;
            return;
        }

        container.innerHTML = members.map((member, index) => `
        <div class="member-card animate-fade-in-up" style="animation-delay: ${index * 50}ms">
            <div class="member-header">
                <div class="member-rank">${member.Rank || index + 1}</div>
                <div class="member-info">
                    <h3><a href="https://fantasy.premierleague.com/entry/${member.Team_ID}/event/${currentGW}" target="_blank" class="manager-link">${member.Manager || 'Unknown'}</a></h3>
                    <p class="member-team">${member.Team || 'Team'}</p>
                </div>
            </div>
            <div class="member-stats">
                <div class="member-stat">
                    <span class="member-stat-value">${formatNumber(member.Total || member.Total_Points || 0)}</span>
                    <span class="member-stat-label">Total Points</span>
                </div>
                <div class="member-stat">
                    <span class="member-stat-value">${formatAwardsStats(member)}</span>
                    <span class="member-stat-label">Awards</span>
                </div>
            </div>
        </div>
    `).join('');
    }

    function formatAwardsStats(member) {
        const weeklyWins = member.Weekly_Wins || 0;
        const monthlyWins = member.Monthly_Wins || 0;
        const prizeMoney = member.Total_Prize_Money || 0;

        if (weeklyWins === 0 && monthlyWins === 0) {
            return '<span class="no-awards">-</span>';
        }

        let parts = [];

        // Monthly wins - Gold cup üèÜ
        if (monthlyWins > 0) {
            parts.push(`<span class="award-badge monthly" title="${monthlyWins} Nh·∫•t th√°ng">${monthlyWins}üèÜ</span>`);
        }

        // Weekly wins - Gold medal ü•á
        if (weeklyWins > 0) {
            parts.push(`<span class="award-badge weekly" title="${weeklyWins} Nh·∫•t tu·∫ßn">${weeklyWins}ü•á</span>`);
        }

        // Prize money
        if (prizeMoney > 0) {
            const formattedPrize = formatPrizeMoney(prizeMoney);
            parts.push(`<span class="award-badge prize" title="${formatNumber(prizeMoney)} VNƒê">üí∞${formattedPrize}</span>`);
        }

        return parts.join(' ');
    }

    function formatPrizeMoney(amount) {
        if (amount >= 1000000) {
            return (amount / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
        } else if (amount >= 1000) {
            return (amount / 1000).toFixed(0) + 'K';
        }
        return amount.toString();
    }
</script>

<style>
    .award-badge {
        display: inline-flex;
        align-items: center;
        gap: 2px;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: 600;
        margin: 0 2px;
    }

    .award-badge.monthly {
        background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
        color: #333;
    }

    .award-badge.weekly {
        background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
        color: #333;
    }

    .award-badge.prize {
        background: linear-gradient(135deg, #4CAF50 0%, #81C784 100%);
        color: white;
    }

    .no-awards {
        color: var(--color-text-tertiary);
    }

    .member-stat-value {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        justify-content: center;
    }

    .manager-link {
        color: inherit;
        text-decoration: none;
        transition: color 0.2s ease;
    }

    .manager-link:hover {
        color: var(--color-primary, #37003c);
        text-decoration: underline;
    }
</style>
{% endblock %}