{% extends "base.html" %}

{% block content %}
<div class="gw-points-page">
    <!-- Data Table Container -->
    <div id="gw-points-table"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // GW Points Page Logic
    let gwDataTable;
    let currentGW = 38; // Will be updated from API

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize data table
        gwDataTable = new DataTable('gw-points-table', {
            searchable: true,
            sortable: true,
            paginated: true,
            exportable: true,
            pageSize: 25,
            hiddenColumns: ['Team_ID'],
            columnOrder: ['Manager', 'Team'],
            compactControls: true
        });

        // Load data if league ID is set
        const leagueId = document.getElementById('league-id').value;
        if (leagueId) {
            loadGWPoints();
        }
    });

    // Override reloadPageData from main.js (force refresh when filters change)
    window.reloadPageData = function (filters) {
        DataCache.clear('gw_points');
        loadGWPoints(true);
    };

    // Get columns to hide (GW > currentGW)
    function getHiddenGWColumns(data, currentGW) {
        if (!data || data.length === 0) return ['Team_ID'];

        const hiddenCols = ['Team_ID'];
        const firstRow = data[0];

        // Find GW columns that are > currentGW
        // Column names are numbers: 1, 2, 3... or "GW1", "GW2"...
        Object.keys(firstRow).forEach(col => {
            // Check if column is a number (GW column)
            const gwNum = parseInt(col);
            if (!isNaN(gwNum) && gwNum > 0 && gwNum <= 38) {
                if (gwNum > currentGW) {
                    hiddenCols.push(col);
                }
            }
            // Also check GW{X} format
            const match = col.match(/^GW(\d+)$/i);
            if (match) {
                const num = parseInt(match[1]);
                if (num > currentGW) {
                    hiddenCols.push(col);
                }
            }
        });

        return hiddenCols;
    }

    async function loadGWPoints(forceRefresh = false) {
        const filters = getCurrentFilters();

        // Validate
        const validation = validateFilters(filters);
        if (!validation.valid) {
            validation.errors.forEach(error => showToast(error, 'error'));
            return;
        }

        try {
            showLoading('Loading GW points...');

            // Fetch current GW first
            try {
                const gwResponse = await fetch('/api/current-gw');
                const gwData = await gwResponse.json();
                if (gwData.success && gwData.current_gw) {
                    currentGW = gwData.current_gw;
                }
            } catch (e) {
                console.warn('Could not fetch current GW, using default');
            }

            const queryString = buildQueryString(filters);
            const data = await cachedFetch('gw_points', `/api/gw-points?${queryString}`, forceRefresh);

            if (data.success) {
                // Update hidden columns based on current GW
                const hiddenCols = getHiddenGWColumns(data.data, currentGW);
                gwDataTable.options.hiddenColumns = hiddenCols;

                gwDataTable.setData(data.data);
                showToast('GW points loaded successfully', 'success');
            } else {
                showToast(data.error || 'Failed to load data', 'error');
            }
        } catch (error) {
            console.error('Error loading GW points:', error);
            showToast('Error loading data', 'error');
        } finally {
            hideLoading();
        }
    }
</script>
{% endblock %}